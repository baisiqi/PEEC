% *************************************************************************
% This code is used to calculate the plane pair inductance based on PEEC.
% The mesh is uniform.
% The code can be used for single or mutiple contacts (shorts).
% *************************************************************************
clear all
close all
tic

N=40;

%%
% *************************************************************************
% Create voltage matrix
% *************************************************************************
A=zeros(N*(N+1)*2,(N+1)^2);
for i=1:N
    for j=1:N+1
        A(j+(N+1)*(i-1),i+(N+1)*(j-1))=1;
        A(j+(N+1)*(i-1),i+(N+1)*(j-1)+1)=-1;
    end
end
for i=1:N^2+N;
    A((N+1)*N+i,i)=1;
    A((N+1)*N+i,i+N+1)=-1;
end
%%
% *************************************************************************
% Create L matrix
% *************************************************************************

Ls11=2*(Lpij(0.5,0.5,0,0.5,0.5,0,0)-Lpij(0.5,0.5,0,0.5,0.5,0,0.8));
Ls12=2*(Lpij(0.5,0.5,0.5,0.5,0.5,0,0)-Lpij(0.5,0.5,0.5,0.5,0.5,0,0.8));
Ls13=2*(Lpij(0.5,0.5,1,0.5,0.5,0,0)-Lpij(0.5,0.5,1,0.5,0.5,0,0.8));
Ls14=2*(Lpij(0.5,0.5,1.5,0.5,0.5,0,0)-Lpij(0.5,0.5,1.5,0.5,0.5,0,0.8));
Ls15=2*(Lpij(0.5,0.5,0,0.5,0.5,2,0)-Lpij(0.5,0.5,0,0.5,0.5,2,0.8));
Ls16=2*(Lpij(0.5,0.5,0.5,0.5,0.5,0.5,0)-Lpij(0.5,0.5,0.5,0.5,0.5,0.5,0.8));
Ls17=2*(Lpij(0.5,0.5,1,0.5,0.5,0.5,0)-Lpij(0.5,0.5,1,0.5,0.5,0.5,0.8));
Ls18=2*(Lpij(0.5,0.5,1.5,0.5,0.5,0.5,0)-Lpij(0.5,0.5,1.5,0.5,0.5,0.5,0.8));
Ls19=2*(Lpij(0.5,0.5,1,0.5,0.5,1,0)-Lpij(0.5,0.5,1,0.5,0.5,1,0.8));

L=diag(ones(N*(N+1),1))*Ls11;
for i=1:N*(N+1)-1
    L(i,i+1)=Ls12;
end
for i=1:N*(N+1)-2
    L(i,i+2)=Ls13;
end
for i=1:N*(N+1)-3
    L(i,i+3)=Ls14;
end
for i=1:N*(N+1)-38
    L(i,i+38)=Ls18;
end
for i=1:N*(N+1)-39
    L(i,i+39)=Ls17;
end
for i=1:N*(N+1)-40
    L(i,i+40)=Ls16;
end
for i=1:N*(N+1)-41
    L(i,i+41)=Ls12;
end
for i=1:N*(N+1)-42
    L(i,i+42)=Ls16;
end
for i=1:N*(N+1)-43
    L(i,i+43)=Ls17;
end
for i=1:N*(N+1)-44
    L(i,i+44)=Ls18;
end
for i=1:N*(N+1)-80
    L(i,i+80)=Ls19;
end
for i=1:N*(N+1)-81
    L(i,i+81)=Ls17;
end
for i=1:N*(N+1)-41*2
    L(i,i+41*2)=Ls13;
end
for i=1:N*(N+1)-83
    L(i,i+83)=Ls17;
end
for i=1:N*(N+1)-84
    L(i,i+84)=Ls19;
end
for i=1:N*(N+1)-122
    L(i,i+122)=Ls18;
end
for i=1:N*(N+1)-41*3
    L(i,i+41*3)=Ls14;
end
for i=1:N*(N+1)-124
    L(i,i+124)=Ls18;
end
for i=1:N*(N+1)-4
    L(i,i+4)=Ls15;
end
for i=1:N*(N+1)-164
    L(i,i+164)=Ls15;
end
L=L+triu(L,1)';
LMatrix=[L,zeros(N*(N+1));zeros(N*(N+1)),L];

for i=[295:298 336:339 377:380]
    LMatrix(i+N*(N+1),:)=0;
end
for i=[295:298 336:339 377:380]
    LMatrix(i,:)=0;
end
for i=[967:970 1008:1011 1049:1052]
    LMatrix(i+N*(N+1),:)=0;
end
for i=[967:970 1008:1011 1049:1052]
    LMatrix(i,:)=0;
end
%%
% *************************************************************************
% Bookkeeping
% *************************************************************************
B=A';
C=0;
for i=[967:970 1008:1011 1049:1052 1090:1093]
    C=C+B(i,:); 
end
B([967:970 1008:1011 1049:1052 1090:1093],:)=[];
B=[C;B];
C=0;
for i=[295:298 336:339 377:380 418:421]
    C=C+B(i+1,:); 
end
B([295:298 336:339 377:380 418:421]+1,:)=[];
B=[C;B];
%%
% *************************************************************************
% Assemble MNA matrix
% *************************************************************************
Source=1051;
Short=379;
M1=[zeros((N+1)^2-30,(N+1)^2),B;A,LMatrix];
M2=zeros((N+1)^2+2*N*(N+1)-30,1);
M2(1)=1;
M3=zeros((N+1)^2+2*N*(N+1),1);
M3(Short)=1;
M=[M1,M2;M3',0];

M(:,(N+1)^2+[295:298 336:339 377:380]+N*(N+1))=[];
M(:,(N+1)^2+[295:298 336:339 377:380])=[];
M(:,(N+1)^2+[967:970 1008:1011 1049:1052]+N*(N+1)-24)=[];
M(:,(N+1)^2+[967:970 1008:1011 1049:1052]-12)=[];
M([968:970 1009:1011 1050:1052]+(N+1)^2-30,:)=[];
M([296:298 337:339 378:380]+(N+1)^2-30,:)=[];
%%
% *************************************************************************
% solve MNA equation
% *************************************************************************
D=zeros(4914,1);
D(2)=1;
R=M\D;
Inductance=abs(R(Source))
t1=toc
plot(R)
%%
% *************************************************************************
% Current plot
% *************************************************************************
current1=R(1682:end-1);
pos1=[295:298 336:339 377:380 967:970 1008:1011 1049:1052];
pos2=pos1+N*(N+1);
pos=[pos1 pos2];

current=zeros(N*(N+1)*2,1);
current(pos)=1;
current(~current)=current1;
current(pos)=nan;
U=zeros(N,N);
V=zeros(N,N);
for i=1:N
    for j=1:N
        U(i,j)=current(j+(i-1)*(N+1));
        V(i,j)=current(N*(N+1)+i+(j-1)*(N+1));
    end
end
[x,y]=meshgrid(0:39,0:39);
figure
quiver(x,y,U,V);
xlabel('X direction');
ylabel('Y direction');
set(gca,'FontSize',20);
set(get(gca,'XLabel'),'FontSize',20);
set(get(gca,'YLabel'),'FontSize',20);
